// g16WPIDML | (c) 2018 GHIFARI160, all rights reserved. | https://github.com/ghifari160/g16WPIDML/LICENSE
!function(e){var t=e.webkitRequestFileSystem||e.mozRequestFileSystem||e.requestFileSystem;function n(e){alert(e)}var i,r=(i=e.webkitURL||e.mozURL||e.URL,{getEntries:function(e,t){zip.createReader(new zip.BlobReader(e),function(e){e.getEntries(t)},n)},getEntryFile:function(e,n,r,l){var a,d,o;function c(){e.getData(a,function(e){var t="Blob"==n?i.createObjectURL(e):d.toURL();r(t)},l)}"Blob"==n?(a=new zip.BlobWriter,c()):(o=function(e){d=e,a=new zip.FileWriter(d),c()},t(TEMPORARY,4194304,function(e){function t(){e.root.getFile(tmpFile_name,{create:!0},function(e){o(e)})}e.root.getFile(tmpFile_name,null,function(e){e.remove(t,t)},t)}))}});!function(){var e=document.getElementById("g16_wpidml_idml_upload"),t=document.getElementById("g16_wpidml_idml_menu");var n=!1,i={};var l=[],a=[];function d(e){e.preventDefault();var n=t.getElementsByTagName("input"),i=document.createElement("table");i.setAttribute("border",1),i.setAttribute("cellspacing",0),i.setAttribute("cellspadding",0);var r=document.createElement("tr"),l=document.createElement("td");l.innerHTML="Order #",r.appendChild(l);var d=document.createElement("td");d.innerHTML="Text Frame Content",r.appendChild(d),i.appendChild(r);for(var c=1,m=0;m<n.length;m++){var u=n[m];if("checkbox"==u.getAttribute("type")&&u.checked){var p=u.getAttribute("id").split("_"),s=p[p.length-1];a.push(s),(r=document.createElement("tr")).setAttribute("id","g16_wpidml_idml_menu_row_"+m),l=document.createElement("td");var g=document.createElement("input");g.setAttribute("type","text"),g.setAttribute("maxlength","3"),g.setAttribute("id","g16_wpidml_idml_menu_order_"+m),g.setAttribute("value",c++),l.appendChild(g),r.appendChild(l),(d=document.createElement("td")).innerHTML=u.parentNode.parentNode.childNodes[1].childNodes[0].innerHTML,r.appendChild(d),i.appendChild(r)}}t.innerHTML="";var h=document.createElement("p");h.innerHTML="Reorder the following text frames",t.appendChild(h),t.appendChild(i);var b=document.createElement("button");b.setAttribute("id","g16_wpidml_menu_nextbtn"),b.innerHTML="Generate Post",b.addEventListener("click",o),t.appendChild(b)}function o(){event.preventDefault();for(var e=[],n="",i=t.getElementsByTagName("input"),r=0;r<i.length;r++){var a=i[r],d=a.getAttribute("id").split("_"),o=d[d.length-1];"text"==a.getAttribute("type")&&(e[a.value-1]=o)}for(r=0;r<e.length;r++)n+=l[e[r]];t.innerHTML="";var c=document.createElement("p");c.innerHTML="Happy editing!<br>";var m=document.createElement("a");m.setAttribute("href","https://github.com/ghifari160/wpidml"),m.setAttribute("target","g16wpidml_tab"),m.innerHTML="g16WPIDML",c.appendChild(m),c.innerHTML+=" by ";var u=document.createElement("a");u.setAttribute("href","https://github.com/ghifari160"),u.setAttribute("target","g16wpidml_tab"),u.innerHTML="Ghifari160",c.appendChild(u),t.appendChild(c),document.getElementById("content-html").click(),document.getElementById("content").value=n,document.getElementById("content-tmce").click(),console.log(e)}function c(){if(n){n&&"application/vnd.adobe.indesign-idml-package"==i.mimetype||m();var e=new DOMParser;for(var r in i){var a=r.split("/");if(a.length>1&&"Stories"==a[0]){var o=a[1].split("_");if(o.length>1&&"Story"==o[0]){o[1];for(var u=i[r],p=e.parseFromString(u,"text/xml").getElementsByTagName("ParagraphStyleRange"),s="",g=0;g<p.length;g++){for(var h="<p>",b=p[g].getElementsByTagName("CharacterStyleRange"),f=0;f<b.length;f++){"Bold"==b[f].getAttribute("FontStyle")?h+="<strong>":"Italic"==b[f].getAttribute("FontStyle")&&(h+="<em>");for(var v=b[f].childNodes,E=0;E<v.length;E++)"Content"==v[E].nodeName?h+=v[E].firstChild.nodeValue:"Br"==v[E].nodeName&&(h+="<br>");"Bold"==b[f].getAttribute("FontStyle")?h+="</strong>":"Italic"==b[f].getAttribute("FontStyle")&&(h+="</em>")}s+=h+="</p>"}"<p></p>"!=s&&l.push(s)}}}!function(){t.innerHTML="";var e=document.createElement("table");e.setAttribute("border",1),e.setAttribute("cellspacing",0),e.setAttribute("cellspadding",0);for(var n=0;n<l.length;n++){var i=document.createElement("tr");i.setAttribute("id","g16_wpidml_idml_menu_row_"+n);var r=document.createElement("td"),a=document.createElement("input");a.setAttribute("type","checkbox"),a.setAttribute("id","g16_wpidml_idml_menu_checkbox_"+n),r.appendChild(a),i.appendChild(r);var o=document.createElement("td");l[n].length>100?o.innerHTML=l[n].substr(0,100)+"...":o.innerHTML=l[n],i.appendChild(o),e.appendChild(i)}var c=document.createElement("p");c.innerHTML="Select any text frames to include them in the post (you will reorder them in the next screen)",t.appendChild(c),t.appendChild(e);var m=document.createElement("button");m.setAttribute("id","g16_wpidml_menu_nextbtn"),m.innerHTML="Next",m.addEventListener("click",d),t.appendChild(m)}()}else setTimeout(c,1e3)}function m(){t.innerHTML="";var e=document.createElement("p");e.innerHTML="Invalid file. Accepted format: IDML",t.appendChild(e)}e.addEventListener("change",function(){if(n=!1,e.disabled=!0,l=e.files[0],"idml"!=(a=l.name.split("."))[a.length-1].toLowerCase())return m(),void(e.disabled=!1);var l,a;r.getEntries(e.files[0],function(l){t.innerHTML="";var a=0;l.forEach(function(t){r.getEntryFile(t,"Blob",function(r){var d=new XMLHttpRequest;d.open("GET",r,!0),d.responseType="blob",d.onload=function(r){if(200==this.status){var d=this.response,o=new FileReader;o.addEventListener("loadend",function(){i[t.filename]=o.result,i.length=a+1,a==l.length-1&&(console.log(i),e.parentNode.removeChild(e),n=!0,c()),a++}),o.readAsText(d)}},d.send()})})})},!1)}()}(this);
